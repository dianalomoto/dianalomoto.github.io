<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendo a Escribir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .guide-text-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: white;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }
        
        #guide-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'cursive', 'Comic Sans MS', sans-serif;
            font-size: 8rem;
            color: #e5e7eb;
            user-select: none;
            pointer-events: none;
            z-index: 1;
        }
        
        #guide-text.small {
            font-size: 6rem;
        }
        
        #guide-text.x-small {
            font-size: 4rem;
        }
        
        #trace-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: crosshair;
            border-radius: 0.5rem;
            border: 2px dashed #d1d5db;
            z-index: 2;
        }

        .score-badge {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .success-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 sm:p-8">

        <!-- Marcador de Puntos (visible en todo momento) -->
        <div class="flex justify-between items-center mb-6 p-4 bg-gradient-to-r from-yellow-400 to-orange-400 rounded-lg shadow-lg">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">⭐</span>
                <span class="text-white font-bold text-lg">Puntos:</span>
            </div>
            <span id="score-display" class="text-white font-bold text-2xl score-badge">0</span>
        </div>

        <!-- Pantalla de Menú -->
        <div id="menu-screen">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-blue-600 mb-8">
                Aprendo a Escribir
            </h1>
            <div class="space-y-4">
                <button id="start-letters-btn" class="w-full text-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-6 rounded-lg font-bold shadow-lg transition transform hover:scale-105 hover:shadow-xl">
                    Trazar Letras
                </button>
                <button id="start-syllables-btn" class="w-full text-lg bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-6 rounded-lg font-bold shadow-lg transition transform hover:scale-105 hover:shadow-xl">
                    Trazar Sílabas
                </button>
                <button id="start-game-btn" class="w-full text-lg bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 px-6 rounded-lg font-bold shadow-lg transition transform hover:scale-105 hover:shadow-xl">
                    Juego de Palabras
                </button>
            </div>
        </div>

        <!-- Pantalla de Trazado -->
        <div id="trace-screen" class="hidden">
            <h2 id="trace-title" class="text-2xl sm:text-3xl font-bold text-center text-gray-700 mb-2">
                Trazar la letra...
            </h2>
            
            <!-- Mensaje de instrucción -->
            <p class="text-center text-sm text-gray-600 mb-4">
                Traza la letra con cuidado para avanzar ✏️
            </p>

            <!-- Mensaje de éxito -->
            <div id="success-message" class="hidden success-message mb-4 p-3 bg-green-100 border-2 border-green-400 rounded-lg text-center">
                <span class="text-green-700 font-bold text-lg">¡Muy bien! ⭐</span>
            </div>
            
            <div class="guide-text-container mb-4">
                <div id="guide-text">S</div>
                <canvas id="trace-canvas"></canvas>
            </div>

            <div id="button-container" class="grid grid-cols-2 gap-4">
                <button id="clear-btn" class="w-full bg-yellow-500 text-white py-3 px-5 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
                    Borrar
                </button>
                <button id="next-btn" class="w-full bg-green-500 text-white py-3 px-5 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
                    Saltar
                </button>
            </div>
            <button id="trace-back-btn" class="w-full mt-4 bg-gray-600 text-white py-3 px-5 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
                Volver al Menú
            </button>
        </div>

        <!-- Pantalla de Juego -->
        <div id="game-screen" class="hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-700 mb-4">
                ¿Qué palabra es?
            </h2>
            
            <img id="game-image" src="https://placehold.co/400x250/8FBC8F/333333?text=Sapo" alt="Imagen del juego" class="w-full h-48 sm:h-64 object-cover rounded-lg shadow-md mb-6">

            <div id="game-options" class="space-y-3"></div>
            
            <p id="game-message" class="text-center font-semibold mt-4 h-6"></p>

            <button id="game-back-btn" class="w-full mt-6 bg-gray-600 text-white py-3 px-5 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
                Volver al Menú
            </button>
        </div>

    </div>

    <footer class="w-full max-w-lg mx-auto text-center text-xs text-gray-500 mt-8 pb-4">
        <p>Desarrollado por Diana Alomoto - Universidad Politécnica Estatal del Carchi</p>
        <p>Información de contacto: 099 005 2651</p>
        <p>email: diana.alomoto@upec.edu.ec</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const data = {
                letters: ['S', 's'],
                syllables: ['sa', 'se', 'si', 'so', 'su'],
                words: [
                    { img: 'https://dianalomoto.github.io/img/sapo.png', word: 'sapo', options: ['sapo', 'sol', 'suma'] },
                    { img: 'https://dianalomoto.github.io/img/serpiente.png', word: 'serpiente', options: ['serpiente', 'silla', 'sapo'] },
                    { img: 'https://dianalomoto.github.io/img/silla.png', word: 'silla', options: ['silla', 'serpiente', 'sol'] },
                    { img: 'https://dianalomoto.github.io/img/sol.png', word: 'sol', options: ['sol', 'suma', 'sapo'] },
                    { img: 'https://dianalomoto.github.io/img/suma.png', word: 'suma', options: ['suma', 'silla', 'serpiente'] }
                ]
            };

            let currentView = 'menu';
            let currentTraceMode = '';
            let currentIndex = 0;
            let currentWordTrace = '';
            let score = 0;
            let strokeCount = 0;
            let hasValidated = false;

            const menuScreen = document.getElementById('menu-screen');
            const traceScreen = document.getElementById('trace-screen');
            const gameScreen = document.getElementById('game-screen');
            const scoreDisplay = document.getElementById('score-display');
            
            const startLettersBtn = document.getElementById('start-letters-btn');
            const startSyllablesBtn = document.getElementById('start-syllables-btn');
            const startGameBtn = document.getElementById('start-game-btn');

            const traceTitle = document.getElementById('trace-title');
            const guideText = document.getElementById('guide-text');
            const canvas = document.getElementById('trace-canvas');
            const clearBtn = document.getElementById('clear-btn');
            const nextBtn = document.getElementById('next-btn');
            const traceBackBtn = document.getElementById('trace-back-btn');
            const buttonContainer = document.getElementById('button-container');
            const successMessage = document.getElementById('success-message');
            const ctx = canvas.getContext('2d');
            
            const gameImage = document.getElementById('game-image');
            const gameOptions = document.getElementById('game-options');
            const gameMessage = document.getElementById('game-message');
            const gameBackBtn = document.getElementById('game-back-btn');

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function updateScore(points) {
                score += points;
                scoreDisplay.textContent = score;
                scoreDisplay.classList.remove('score-badge');
                void scoreDisplay.offsetWidth; // Trigger reflow
                scoreDisplay.classList.add('score-badge');
            }

            function showView(viewName) {
                menuScreen.classList.add('hidden');
                traceScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');

                if (viewName === 'menu') {
                    menuScreen.classList.remove('hidden');
                } else if (viewName === 'trace') {
                    traceScreen.classList.remove('hidden');
                } else if (viewName === 'game') {
                    gameScreen.classList.remove('hidden');
                }
                currentView = viewName;
            }

            function navigateToMenu() {
                showView('menu');
            }

            function resizeCanvas() {
                const container = canvas.parentElement;
                const rect = container.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                setupCanvasContext();
            }

            function setupCanvasContext() {
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 8;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            function getCanvasCoordinates(e, touch = false) {
                const rect = canvas.getBoundingClientRect();
                const clientX = touch ? e.touches[0].clientX : e.clientX;
                const clientY = touch ? e.touches[0].clientY : e.clientY;
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            // Función para validar el trazo
            function validateTrace() {
                if (hasValidated) return; // Ya validó este trazo

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let drawnPixels = 0;

                // Contar píxeles dibujados (con alpha > 0)
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] > 0) {
                        drawnPixels++;
                    }
                }

                const totalPixels = canvas.width * canvas.height;
                const coverage = drawnPixels / totalPixels;

                // Ajustar umbral según el tipo de contenido y modo
                let requiredCoverage = 0.015; // Para letras individuales
                let minStrokes = 2; // Mínimo de trazos
                const currentText = guideText.textContent.toLowerCase();
                
                if (currentText.length > 3) {
                    // Para palabras del juego, ser más estricto
                    if (currentTraceMode === 'word') {
                        requiredCoverage = 0.025; // Requiere más cobertura
                        minStrokes = Math.max(4, currentText.length - 2); // Más trazos según longitud
                    } else {
                        requiredCoverage = 0.008;
                        minStrokes = 3;
                    }
                } else if (currentText.length > 1) {
                    requiredCoverage = 0.012; // Sílabas
                    minStrokes = 2;
                }

                // Validar trazo con condiciones más flexibles
                if (coverage >= requiredCoverage && strokeCount >= minStrokes) {
                    hasValidated = true;
                    
                    // Mostrar mensaje de éxito
                    successMessage.classList.remove('hidden');
                    
                    // Dar puntos
                    updateScore(10);
                    
                    // Avanzar automáticamente después de 1.5 segundos
                    setTimeout(() => {
                        successMessage.classList.add('hidden');
                        advanceToNext();
                    }, 1500);
                }
            }

            function advanceToNext() {
                if (currentTraceMode === 'word') {
                    // Volver al juego y cargar la siguiente pregunta
                    currentIndex = (currentIndex + 1) % data.words.length;
                    loadGameQuestion();
                    showView('game');
                } else {
                    // Avanzar a la siguiente letra o sílaba
                    const items = data[currentTraceMode];
                    currentIndex = (currentIndex + 1) % items.length;
                    
                    const titlePrefix = currentTraceMode === 'letters' ? 'Traza la letra:' : 'Traza la sílaba:';
                    traceTitle.textContent = `${titlePrefix} ${items[currentIndex]}`;
                    updateGuideText(items[currentIndex]);
                    clearCanvas();
                }
            }

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const coords = getCanvasCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const coords = getCanvasCoordinates(e);
                draw(coords.x, coords.y);
            });

            canvas.addEventListener('mouseup', () => {
                if (isDrawing) {
                    isDrawing = false;
                    strokeCount++;
                    validateTrace();
                }
            });

            canvas.addEventListener('mouseleave', () => {
                if (isDrawing) {
                    isDrawing = false;
                    strokeCount++;
                    validateTrace();
                }
            });

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const coords = getCanvasCoordinates(e, true);
                lastX = coords.x;
                lastY = coords.y;
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const coords = getCanvasCoordinates(e, true);
                draw(coords.x, coords.y);
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (isDrawing) {
                    isDrawing = false;
                    strokeCount++;
                    validateTrace();
                }
            });

            function draw(x, y) {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                lastX = x;
                lastY = y;
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                strokeCount = 0;
                hasValidated = false;
                successMessage.classList.add('hidden');
            }

            function updateGuideText(text) {
                guideText.textContent = text;
                guideText.classList.remove('small', 'x-small');
                if (text.length > 3) {
                    guideText.classList.add('x-small');
                } else if (text.length > 1) {
                    guideText.classList.add('small');
                }
            }

            function startTrace(mode) {
                currentTraceMode = mode;
                currentIndex = 0;
                
                if (mode === 'word') {
                    nextBtn.classList.add('hidden');
                    buttonContainer.classList.remove('grid-cols-2');
                    buttonContainer.classList.add('grid-cols-1');
                    
                    traceTitle.textContent = '¡Traza la palabra!';
                    updateGuideText(currentWordTrace);
                } else {
                    nextBtn.classList.remove('hidden');
                    buttonContainer.classList.add('grid-cols-2');
                    buttonContainer.classList.remove('grid-cols-1');

                    const items = data[currentTraceMode];
                    const titlePrefix = mode === 'letters' ? 'Traza la letra:' : 'Traza la sílaba:';
                    traceTitle.textContent = `${titlePrefix} ${items[currentIndex]}`;
                    updateGuideText(items[currentIndex]);
                }
                
                showView('trace');
                setTimeout(() => {
                    resizeCanvas();
                    clearCanvas();
                }, 100);
            }

            nextBtn.addEventListener('click', () => {
                advanceToNext();
            });

            clearBtn.addEventListener('click', clearCanvas);

            function loadGameQuestion() {
                const item = data.words[currentIndex];
                gameImage.src = item.img;
                gameImage.alt = `Imagen de ${item.word}`;
                gameMessage.textContent = '';
                gameOptions.innerHTML = '';

                const shuffledOptions = item.options.sort(() => Math.random() - 0.5);

                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('w-full', 'text-lg', 'bg-purple-500', 'text-white', 'py-3', 'px-5', 'rounded-lg', 'font-semibold', 'shadow-md', 'transition', 'transform', 'hover:bg-purple-600', 'hover:scale-105');
                    button.addEventListener('click', () => checkAnswer(option, item.word));
                    gameOptions.appendChild(button);
                });
            }

            function checkAnswer(selectedOption, correctWord) {
                if (selectedOption === correctWord) {
                    gameMessage.textContent = '¡Muy bien! ¡Genial!';
                    gameMessage.classList.remove('text-red-500');
                    gameMessage.classList.add('text-green-500');
                    
                    // Dar puntos por respuesta correcta
                    updateScore(5);

                    setTimeout(() => {
                        currentWordTrace = correctWord;
                        startTrace('word');
                    }, 1000);
                } else {
                    gameMessage.textContent = 'Inténtalo de nuevo';
                    gameMessage.classList.remove('text-green-500');
                    gameMessage.classList.add('text-red-500');
                }
            }

            startLettersBtn.addEventListener('click', () => startTrace('letters'));
            startSyllablesBtn.addEventListener('click', () => startTrace('syllables'));
            startGameBtn.addEventListener('click', () => {
                currentIndex = 0;
                loadGameQuestion();
                showView('game');
            });
            
            traceBackBtn.addEventListener('click', navigateToMenu);
            gameBackBtn.addEventListener('click', navigateToMenu);

            window.addEventListener('resize', () => {
                if (currentView === 'trace') {
                    resizeCanvas();
                    clearCanvas();
                }
            });
        });
    </script>
</body>
</html>
